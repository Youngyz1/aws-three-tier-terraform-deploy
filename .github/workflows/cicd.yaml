name: Deploy to AWS with Terraform

on:
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write

jobs:
  deploy-iac:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      DOMAIN_NAME: ofiliyoungyz.site
      ROUTE53_ZONE_ID: ${{ secrets.ROUTE53_ZONE_ID }}
    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Configure AWS credentials using OIDC
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3Ô∏è‚É£ Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.7.6"
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      # 4Ô∏è‚É£ Terraform Init, Format & Validate
      - name: Terraform Init
        run: terraform init
      - name: Terraform Format
        run: terraform fmt -check
      - name: Terraform Validate
        run: terraform validate

      # 5Ô∏è‚É£ Security Scan
      - name: tfsec Security Scan
        run: |
          curl -sLo tfsec https://github.com/aquasecurity/tfsec/releases/download/v1.28.11/tfsec-linux-amd64
          chmod +x tfsec
          ./tfsec --version
          ./tfsec . || true

      # 6Ô∏è‚É£ Terraform Plan & Apply
      - name: Terraform Plan
        run: terraform plan
      - name: Terraform Apply
        run: terraform apply -auto-approve

      # 7Ô∏è‚É£ Configure kubectl
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.32.0'

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ vars.EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

      # 8Ô∏è‚É£ Get NGINX Ingress Load Balancer Hostname
      - name: Get NGINX LB Hostname
        id: get_lb
        run: |
          LB_HOST=$(kubectl get svc nginx-ingress-ingress-nginx-controller -n ingress-nginx \
                     -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "LB_HOST=$LB_HOST" >> $GITHUB_ENV
          echo "NGINX LB Hostname: $LB_HOST"

      # 9Ô∏è‚É£ Update Route 53 DNS Records
      - name: Update Route 53 Records
        run: |
          for SUBDOMAIN in "" "bank" "bankapi" "argocd"; do
            FULL_DOMAIN="${SUBDOMAIN:+$SUBDOMAIN.}${{ env.DOMAIN_NAME }}"
            echo "Updating $FULL_DOMAIN -> $LB_HOST"
            aws route53 change-resource-record-sets \
              --hosted-zone-id "${{ env.ROUTE53_ZONE_ID }}" \
              --change-batch "{
                \"Changes\": [
                  {
                    \"Action\": \"UPSERT\",
                    \"ResourceRecordSet\": {
                      \"Name\": \"$FULL_DOMAIN\",
                      \"Type\": \"CNAME\",
                      \"TTL\": 300,
                      \"ResourceRecords\": [{\"Value\": \"$LB_HOST\"}]
                    }
                  }
                ]
              }"
          done

      # üîü Deploy ArgoCD ingress
      - name: Deploy ArgoCD ingress
        run: kubectl apply -f ingress-argocd.yaml -n argocd

      # 1Ô∏è‚É£1Ô∏è‚É£ Optional: Destroy resources (for testing only)
      # - name: Terraform Destroy
      #   run: terraform destroy -auto-approve
